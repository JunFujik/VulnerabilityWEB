from fastapi import FastAPI
from fastapi.responses import HTMLResponse, FileResponse
from fastapi.middleware.gzip import GZipMiddleware
from .api import app as api
from .db import db
import os

app=FastAPI(docs_url=None, redoc_url=None)
app.add_middleware(GZipMiddleware, minimum_size=1)
app.mount("/api/v1", api)

with open("client/public/index.html", "r") as index_file:
    index=index_file.read()

@app.get('/{full_path:path}')
async def spa(full_path:str):
    if full_path=="": full_path="index.html"
    if os.path.exists("client/public/"+full_path):
        return FileResponse("client/public/"+full_path)
    else:
        return HTMLResponse(index)

db.init()

@app.on_event("startup")
async def startup():
    await db.create_all()

@app.on_event("shutdown")
async def shutdown():
    await db.close()