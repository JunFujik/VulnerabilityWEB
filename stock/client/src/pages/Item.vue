<template>
  <section v-if="userStore.user.is_store" class="section">
    <p class="title">あなたのお店の商品</p>
    <o-button @click="onClick()" v-if="shopStore.shops.length" >商品を新規登録する</o-button>
    <o-button @click="onShopCreate()" v-else >お店を新規登録する(商品の登録にはお店が必要です)</o-button>
    <ItemList :items="shopStore.items" :item-images="shopStore.itemImages" editable />
  </section>
  <section class="section">
    <p class="title">商品を検索</p>
    <o-field>
      <o-input v-model="input" placeholder="商品を検索" type="search" icon="search" @blur="onSearch()" expanded></o-input>
      <o-button variant="primary" @click="onSearch()">検索</o-button>
    </o-field>
    <ItemList :items="items" :item-images="item_images"></ItemList>
  </section>
</template>
  
<script lang="ts" setup>
import ItemList from '../components/ItemList.vue';
import { useShopStore } from '../store/shop';
import { useUserStore } from '../store/user';
import { useProgrammatic } from '@oruga-ui/oruga-next'
import ItemDialog from '../components/dialog/ItemDialog.vue';
import ShopDialog from '../components/dialog/ShopDialog.vue';
import { onMounted, ref } from 'vue';
import { openApi } from '../utils/openApi';
import { Item } from '../openapi';

const items=ref<Item[]>([])
const item_images=ref<{[key:string]:string}>({})
const input=ref('')

const shopStore=useShopStore() 
const userStore=useUserStore()

const { oruga } = useProgrammatic()

const onClick=async () => {
  oruga.modal.open({
    component: ItemDialog,
    props: {
      editable:true
    },
    trapFocus: true,
  })
}

const onShopCreate=async () => {
  oruga.modal.open({
    component: ShopDialog,
    props: {
      editable:true
    },
    trapFocus: true,
  })
}

const onSearch=async () => {
  items.value=(await openApi.searchSearchItemGet(input.value)).data
  item_images.value={}
  items.value.forEach((item)=> {
    item_images.value[item.id]=`/api/v1/image/item/${item.id}/`
  })
}

onMounted(async () => {
  await onSearch()
})
</script>

<style scoped>
</style>