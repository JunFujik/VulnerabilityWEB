<template>
  <section>
    <h1 class="title">アカウント設定</h1>
  </section>
  <o-field label="アカウントアイコン" message="pngかjpeg形式の画像が使用できます。">
    <ImageSelect v-model="image" :default-image="userStore.userIcon" @update:modelValue="changeIcon"></ImageSelect>
  </o-field>
  <Form @submit="onSubmit" :validation-schema="schema" :initial-values="{name:userStore.user.name, email:userStore.user.email}">
    <Field name="name" v-slot="{ field, errors, meta }">
      <o-field label="アカウント名" :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
        :message="errors[0] ? errors[0] : ''">
        <o-input v-model="name" v-bind="field" />
      </o-field>
    </Field>
    <Field name="email" v-slot="{ field, errors, meta }">
      <o-field label="メールアドレス" :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
        :message="errors[0] ? errors[0] : ''">
        <o-input v-model="email" type="email" v-bind="field" />
      </o-field>
    </Field>
    <div class="pt-1 buttons is-right">
      <o-button variant="success" native-type="submit">保存</o-button>
    </div>
  </Form>
  <o-field label="その他">
    <div class="buttons">
      <o-button variant="danger" @click="changePassword()">パスワードを変更</o-button>
      <o-button variant="danger" @click="confirmAccountDelete()">アカウントを削除</o-button>
    </div>
  </o-field>

</template>

<script lang="ts" setup>
import { Form, Field } from "vee-validate";
import { useProgrammatic } from '@oruga-ui/oruga-next'
import { onMounted, ref } from "vue";
import * as yup from "yup";
import Delete from "../components/auth-dialog/Delete.vue";
import chPassword from "../components/auth-dialog/chPassword.vue";
import ImageSelect from "../components/ImageSelect.vue";
import { useUserStore } from "../store/user";
import { AxiosError } from "axios";

const image = ref(null)
const userStore = useUserStore()
const { oruga } = useProgrammatic()

const name = ref(userStore.user.name)
const email = ref(userStore.user.email)

const schema = yup.object().shape({
  name: yup.string().required(),
  email: yup.string().required().email(),
});

const onSubmit = async (values: any) => {
  try{
    await userStore.updateInfo(values.name, values.email)
  } catch (e) {
    if (e instanceof AxiosError){
      oruga.notification.open({
        message: e.response?.data.description,
        rootClass: 'toast-notification',
        position: 'top',
        variant: "danger"
      })
    }
  }
}

const confirmAccountDelete = async () => {
  oruga.modal.open({
    component: Delete,
    props: {
      reason: "button"
    },
    trapFocus: true,
  })
}

const changePassword = async () => {
  oruga.modal.open({
    component: chPassword,
    props: {
      reason: "button"
    },
    trapFocus: true,
  })
}

const changeIcon = async () => {
  try {
    await userStore.updateIcon(image.value ?? undefined)
    oruga.notification.open({
      message: "アカウントアイコンのアップロードに成功しました。",
      rootClass: 'toast-notification',
      position: 'top',
      variant: "success"
    })
  } catch(e) {
    if (e instanceof AxiosError){
      oruga.notification.open({
        message: e.response?.data.description,
        rootClass: 'toast-notification',
        position: 'top',
        variant: "danger"
      })
    }
  }
  
}

onMounted(async () => {
  await userStore.init()
  name.value = userStore.user.name
  email.value = userStore.user.email
})
</script>

<style scoped>

</style>