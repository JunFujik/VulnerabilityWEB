<template>
  <section>
    <h1 class="title">新規登録</h1>
  </section>
  <o-notification type="info" variant="info" :closable="false">
    お店用のアカウントはこのページでは登録できません。<br /> 
    <router-link to="/ShopSignup">こちら</router-link>から作成してください。
  </o-notification>
  <o-button tag="a" href="/api/v1/sso/google/" icon-left="google" expanded>Googleでサインアップ</o-button>
  <div class="divider">or</div>
  <o-field label="アカウントアイコン" message="pngかjpeg形式の画像が使用できます。">
    <ImageSelect v-model="image"></ImageSelect>
  </o-field>
  <Form @submit="onSubmit" :validation-schema="schema">
    <Field name="name" v-slot="{ field, errors, meta }">
      <o-field
        label="お名前"
        :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
        :message="errors[0] ? errors[0] : ''">
        <o-input v-bind="field" />
      </o-field>
    </Field>
    <Field name="email" v-slot="{ field, errors, meta }">
      <o-field
        label="メールアドレス"
        :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
        :message="errors[0] ? errors[0] : ''">
        <o-input type="email" v-bind="field" />
      </o-field>
    </Field>
    <Field name="password" v-slot="{ field, errors, meta }">
      <o-field
        label="パスワード"
        :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
        :message="errors[0] ? errors[0] : ''">
        <o-input type="password" v-bind="field" password-reveal />
      </o-field>
    </Field>
    <Field name="confirm_password" v-slot="{ field, errors, meta }">
      <o-field
        label="パスワード(確認)"
        :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
        :message="errors[0] ? errors[0] : ''">
        <o-input type="password" placeholder="上で入力したものをもう一度入力してください。" v-bind="field" password-reveal />
      </o-field>
    </Field>
    <div class="pt-1">
      <o-button class="button is-success is-pulled-right" native-type="submit">登録</o-button>
      <router-link to="/Signin">すでにアカウントをお持ちですか？</router-link>
    </div>
  </Form>
</template> 
<script lang="ts" setup>
import { AxiosError } from "axios";
import { Form, Field } from "vee-validate";
import { ref } from "vue";
import { useRouter } from "vue-router";
import * as yup from "yup";
import ImageSelect from "../components/ImageSelect.vue";
import { useUserStore } from '../store/user';
import { useProgrammatic } from '@oruga-ui/oruga-next'

const image = ref(null)
const userStore = useUserStore()
const router = useRouter()
const { oruga } = useProgrammatic()

const schema = yup.object().shape({
  name: yup.string().required(),
  email: yup.string().required().email(),
  password: yup.string().required().min(6),
  confirm_password:yup.string().label("Confirmation Password").required().min(6).oneOf([yup.ref('password'), null], 'Passwords must match')
});

const onSubmit = async (values:any) => {
  try {
    await userStore.signUp(values.name, values.email, values.password, false)
    if(image.value){
      userStore.updateIcon(image.value)
    }
    router.push("/")
  } catch (e) {
    if (e instanceof AxiosError){
      oruga.notification.open({
        message: e.response?.data.description,
        rootClass: 'toast-notification',
        position: 'top',
        variant: "danger"
      })
    }
  }
}
</script>
<style scoped>
@import "@creativebulma/bulma-divider";
</style>