<template>
  <section>
    <h1 class="title">ショップ新規登録</h1>
  </section>
  <o-steps v-model="step" :hasNavigation="false">
    <o-step-item step="1" label="アカウント作成">
      <o-field label="アカウントアイコン" message="pngかjpeg形式の画像が使用できます。">
        <ImageSelect v-model="accountimage"></ImageSelect>
      </o-field>
      <Form @submit="onAccountSubmit" :validation-schema="Accountschema">
        <Field name="name" v-slot="{ field, errors, meta }">
          <o-field
            label="アカウント名"
            :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
            :message="errors[0] ? errors[0] : ''">
            <o-input v-bind="field" />
          </o-field>
        </Field>
        <Field name="email" v-slot="{ field, errors, meta }">
          <o-field
            label="メールアドレス"
            :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
            :message="errors[0] ? errors[0] : ''">
            <o-input type="email" v-bind="field" />
          </o-field>
        </Field>
        <Field name="password" v-slot="{ field, errors, meta }">
          <o-field
            label="パスワード"
            :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
            :message="errors[0] ? errors[0] : ''">
            <o-input type="password" v-bind="field" password-reveal />
          </o-field>
        </Field>
        <Field name="confirm_password" v-slot="{ field, errors, meta }">
          <o-field
            label="パスワード(確認)"
            :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
            :message="errors[0] ? errors[0] : ''">
            <o-input type="password" placeholder="上で入力したものをもう一度入力してください。" v-bind="field" password-reveal />
          </o-field>
        </Field>
        <div class="pt-1">
          <o-button class="button is-success is-pulled-right" native-type="submit">サインアップ</o-button>
          <router-link to="/Signin">すでにアカウントをお持ちですか？</router-link>
        </div>
      </Form>
    </o-step-item>
    <o-step-item step="2" label="お店の登録">
      <o-field label="お店のアイコン" message="pngかjpeg形式の画像が使用できます。">
        <ImageSelect v-model="shopimage"></ImageSelect>
      </o-field>
      <Form @submit="onShopSubmit" :validation-schema="Shopschema">
        <Field name="name" v-slot="{ field, errors, meta }">
          <o-field
            label="店名"
            :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
            :message="errors[0] ? errors[0] : ''">
            <o-input v-bind="field" />
          </o-field>
        </Field>
        <Field name="description" v-slot="{ field, errors, meta }">
          <o-field
            label="お店の説明"
            :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
            :message="errors[0] ? errors[0] : ''">
            <o-input type="textarea" v-bind="field" />
          </o-field>
        </Field>
        <Field name="address" v-slot="{ field, errors, meta }">
          <o-field
            label="所在地"
            :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
            :message="errors[0] ? errors[0] : ''">
            <o-input v-bind="field"/>
          </o-field>
        </Field>
        <div class="pt-1">
          <o-button class="button is-success is-pulled-right" native-type="submit">登録</o-button>
        </div>
      </Form>
    </o-step-item>
    <o-step-item step="3" label="商品の登録">
      <o-button expanded>レジと同期</o-button>
      <div class="divider">or</div>
    </o-step-item>
  </o-steps>
</template>
<script lang="ts" setup>
import { Form, Field } from "vee-validate";
import { ref } from "vue";
import * as yup from "yup";
import ImageSelect from "../components/ImageSelect.vue";
import { useUserStore } from "../store/user";
import { useProgrammatic } from '@oruga-ui/oruga-next'
import { AxiosError } from "axios";
import { useShopStore } from "../store/shop";

const step = ref(0)
const accountimage = ref(null)
const shopimage = ref(null)
const userStore=useUserStore()
const shopStore=useShopStore()
const { oruga } = useProgrammatic()

const Accountschema = yup.object().shape({
  name: yup.string().required(),
  email: yup.string().required().email(),
  password: yup.string().required().min(6),
  confirm_password:yup.string().label("Confirmation Password").required().min(6).oneOf([yup.ref('password'), null], 'Passwords must match')
});

const onAccountSubmit = async (values:any) => {
  try {
    await userStore.signUp(values.name, values.email, values.password, true)
    if(accountimage.value){
      try{
        await userStore.updateIcon(accountimage.value)
      } catch(e){
        oruga.notification.open({
          message: "アカウントアイコンのアップロードに失敗しました。",
          rootClass: 'toast-notification',
          position: 'top',
          variant: "danger"
        })
      }
    }
    step.value=2
  } catch (e) {
    if (e instanceof AxiosError){
      oruga.notification.open({
        message: e.response?.data.description,
        rootClass: 'toast-notification',
        position: 'top',
        variant: "danger"
      })
    }
  }
}

const Shopschema = yup.object().shape({
  name: yup.string().required(),
  description: yup.string().required(),
  address:yup.string().required(),
});

const onShopSubmit = async (values:any) => {
  try {
    const shop_id=await shopStore.createShop(values.name, values.description, values.address, [0,0])
    if(shopimage.value){
      try{
        await shopStore.updateShopIcon(shop_id, shopimage.value )
      } catch(e){
        oruga.notification.open({
          message: "ショップアイコンのアップロードに失敗しました。",
          rootClass: 'toast-notification',
          position: 'top',
          variant: "danger"
        })
      }
    }
    step.value=3
  } catch (e) {
    if (e instanceof AxiosError){
      oruga.notification.open({
        message: e.response?.data.description,
        rootClass: 'toast-notification',
        position: 'top',
        variant: "danger"
      })
    }
  }
}
</script>
<style scoped>
@import "@creativebulma/bulma-divider";
</style>