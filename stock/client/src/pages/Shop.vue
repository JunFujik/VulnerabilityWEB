<template>
  <section v-if="userStore.user.is_store" class="section">
    <p class="title">あなたのお店</p>
    <o-button @click="onClick()">お店を新規登録する</o-button>
    <ShopList :shops="shopStore.shops" :shop-images="shopStore.shopIcons" editable />
  </section>
  <section class="section">
    <p class="title">お店を検索</p>
    <o-field>
      <o-input v-model="input" placeholder="お店を検索" type="search" icon="search" @blur="onSearch()" expanded></o-input>
      <o-button variant="primary" @click="onSearch()">検索</o-button>
    </o-field>
    <ShopList :shops="shops" :shop-images="shop_images" />
  </section>
</template>
  
<script lang="ts" setup>
import ShopList from '../components/ShopList.vue';
import { useShopStore } from '../store/shop';
import { useUserStore } from '../store/user';
import { useProgrammatic } from '@oruga-ui/oruga-next'
import ShopDialog from '../components/dialog/ShopDialog.vue';
import { onMounted, ref } from 'vue';
import { openApi } from '../utils/openApi';
import { ShopWithitems } from '../openapi';

const shops=ref<ShopWithitems[]>([])
const shop_images=ref<{[key:string]:string}>({})
const input=ref('')

const shopStore=useShopStore() 
const userStore=useUserStore()

const { oruga } = useProgrammatic()

const onClick=async () => {
  oruga.modal.open({
    component: ShopDialog,
    props: {
      editable:true
    },
    trapFocus: true,
  })
}

const onSearch=async () => {
  shops.value=(await openApi.searchSearchShopGet(input.value)).data
  shop_images.value={}
  shops.value.forEach((shop)=> {
    shop_images.value[shop.id]=`/api/v1/image/shop/${shop.id}/`
  })
}

onMounted(async () => {
  await onSearch()
})
</script>

<style scoped>
</style>