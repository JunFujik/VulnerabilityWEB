<template>
  <form @submit="onSubmit">
  <o-field label="お店のアイコン" message="pngかjpeg形式の画像が使用できます。">
    <ImageSelect v-model="image" :default-image="`/api/v1/image/shop/${props.shop?.id}/`"></ImageSelect>
  </o-field>
  <Field name="name" v-slot="{ field, errors, meta }">
    <o-field label="店名" :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
      :message="errors[0] ? errors[0] : ''">
      <o-input v-model="name" v-bind="field" />
    </o-field>
  </Field>
  <Field name="description" v-slot="{ field, errors, meta }">
    <o-field label="お店の説明" :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
      :message="errors[0] ? errors[0] : ''">
      <o-input v-model="description" type="textarea" v-bind="field" />
    </o-field>
  </Field>
  <Field name="address" v-slot="{ field, errors, meta }">
    <o-field
      label="所在地"
      :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
      :message="errors[0] ? errors[0] : ''">
      <o-input v-model="address" v-bind="field"/>
    </o-field>
  </Field>
  </form>
</template>
<script setup lang="ts">
import { Form, Field, useForm } from "vee-validate";
import { ref } from "vue";
import * as yup from "yup";
import { defineProps } from 'vue';
import ImageSelect from "../ImageSelect.vue";
import { ShopWithitems } from "../../openapi";
import { useShopStore } from "../../store/shop";

const shopStore=useShopStore()

const image = ref(null)

const props =defineProps<{
  shop?: ShopWithitems
}>()

const name=ref(props.shop?.name ?? '')
const description=ref(props.shop?.description)
const address=ref(props.shop?.address)

const schema = yup.object().shape({
  name: yup.string().required(),
  description: yup.string().required(),
  address:yup.string().required(),
});

const {handleSubmit} = useForm({validationSchema:schema, initialValues:{name:props.shop?.name??'', description:props.shop?.description??'', address:props.shop?.address??''}})

const onSubmit = handleSubmit(async (values) => {
  if(props.shop){
    try {
      if (image.value) {
        await shopStore.updateShopIcon(props.shop.id, image.value)
      }
      await shopStore.updateShop(props.shop.id, values.name, values.description, values.address)
      return true
    } catch (e) {
      alert(e)
      return false
    }
  } else {
    try{
      const item=await shopStore.createShop(values.name, values.description, values.address, [0,0])
      if (image.value) {
        await shopStore.updateShopIcon(item, image.value)
      }
      return true
    } catch (e) {
      alert(e)
      return false
    }
  }
})

const onDelete = async () => {
  if(props.shop){
    await shopStore.deleteShop(props.shop?.id)
  }
}

defineExpose({onSubmit, onDelete})
</script>
<style scoped>

</style>