<template>
  <form @submit="onSubmit">
    <o-field label="商品のイメージ" message="pngかjpeg形式の画像が使用できます。">
      <ImageSelect v-model="image" :default-image="`/api/v1/image/item/${props.item?.id}/`"></ImageSelect>
    </o-field>
    <Field name="name" v-slot="{ field, errors, meta }">
      <o-field label="商品名" :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
        :message="errors[0] ? errors[0] : ''">
        <o-input v-model="name" v-bind="field" />
      </o-field>
    </Field>
    <Field name="description" v-slot="{ field, errors, meta }">
      <o-field label="商品の説明" :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
        :message="errors[0] ? errors[0] : ''">
        <o-input v-model="description" type="textarea" v-bind="field" />
      </o-field>
    </Field>
    <o-field label="在庫数">
      <o-slider v-model="stocks"></o-slider>
    </o-field>
    <Field name="stock_description" v-slot="{ field, errors, meta }">
      <o-field label="商品の在庫位置の説明" :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
        :message="errors[0] ? errors[0] : ''">
        <o-input v-model="stock_description" type="textarea" v-bind="field" />
      </o-field>
    </Field>
    <o-field label="販売店">
      <o-select placeholder="商品の販売店を選んでください" v-model="shop_id" v-for="shop in shopStore.shops" :key="shop.id">
        <option :value="shop.id">{{shop.name}}</option>
      </o-select>
    </o-field>
  </form>
</template>
<script setup lang="ts">
import { Form, Field, useForm } from "vee-validate";
import { ref } from "vue";
import * as yup from "yup";
import { defineProps } from 'vue';
import ImageSelect from "../ImageSelect.vue";
import { Item } from "../../openapi";
import { useShopStore } from "../../store/shop";

const shopStore=useShopStore()

const image = ref(null)

const props =defineProps<{
  item?: Item
}>()

const name=ref(props.item?.name ?? '')
const description=ref(props.item?.description??'')
const shop_id=ref(props.item?.shop_id??shopStore.shops[0].id)
const stocks=ref(props.item?.stock.stocks??0)
const stock_description=ref(props.item?.stock.description??'')

const schema = yup.object().shape({
  name: yup.string().required(),
  description: yup.string().required(),
  stock_description: yup.string().required(),
});

const {handleSubmit} = useForm({validationSchema:schema, initialValues:{name:props.item?.name??'',description:props.item?.description??'', stock_description:props.item?.stock.description??''}})

const onSubmit = handleSubmit(async (values) => {
  if(props.item){
    try {
      if (image.value) {
        await shopStore.updateItemIcon(props.item.id, image.value)
      }
      await shopStore.updateItem(props.item.id, values.name, values.description, {stocks:stocks.value, lat:0.0, lng:0.0, description:values.stock_description})
      return true
    } catch (e) {
      alert(e)
      return false
    }
  } else {
    try{
      const item=await shopStore.createItem(values.name, values.description, {stocks:stocks.value, lat:0.0, lng:0.0, description:values.stock_description}, shop_id.value)
      if (image.value) {
        await shopStore.updateItemIcon(item, image.value)
      }
      return true
    } catch (e) {
      alert(e)
      return false
    }
  }
})

const onDelete = async () => {
  if(props.item){
    await shopStore.deleteItem(props.item?.id)
  }
}

defineExpose({onSubmit, onDelete})
</script>
<style scoped>

</style>