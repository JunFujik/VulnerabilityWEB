<template>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">アカウントの削除</p>
    </header>
    <Form @submit="onSubmit" :validation-schema="schema">
    <section class="modal-card-body">
      本当にアカウントを削除してもよろしければ、以下にパスワードを入力して削除ボタンを押してください。
      <Field name="password" v-slot="{ field, errors, meta }">
        <o-field
          label="パスワード"
          :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
          :message="errors[0] ? errors[0] : ''">
          <o-input type="password" v-bind="field" password-reveal></o-input>
        </o-field>
      </Field>
    </section>
    <footer class="modal-card-foot">
      <o-button variant="success" native-type="submit">削除</o-button>
      <o-button @click="onCancel()">キャンセル</o-button>
    </footer>
    </Form>
  </div>
</template>
<script setup lang="ts">
import { defineProps, defineEmits } from 'vue'
import { Form, Field } from "vee-validate";
import * as yup from "yup";
import { useRouter } from 'vue-router'
import { useUserStore } from '../../store/user';
import { useProgrammatic } from '@oruga-ui/oruga-next'
import { AxiosError } from 'axios';

const userStore = useUserStore()
const { oruga } = useProgrammatic()
const router = useRouter()

const emit = defineEmits<{(e: 'close', v:{'action':String, 'method':String}):void}>()

const schema = yup.object().shape({
  password: yup.string().required().min(6)
});

const onSubmit = async (values:any) => {
  try {
    await userStore.deleteUser(values.password)
    emit('close', {'action':'signin', 'method':''})
    router.push("/")
  } catch (e) {
    if (e instanceof AxiosError){
      oruga.notification.open({
        message: e.response?.data.description,
        rootClass: 'toast-notification',
        position: 'top',
        variant: "danger"
      })
    }
  }
}

const onCancel = async () => {
  emit('close', {'action':'cancel', 'method':'cancel'})
}

</script>
<style scoped>
</style>