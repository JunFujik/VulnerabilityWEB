<template>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">パスワードの変更</p>
    </header>
    <Form @submit="onSubmit" :validation-schema="schema">
    <section class="modal-card-body">
      パスワードを変更するには、現在のパスワードと新しいパスワードを2回入力して、「変更」ボタンを押してください。
      <Field name="oldpassword" v-slot="{ field, errors, meta }">
        <o-field
          label="現在のパスワード"
          :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
          :message="errors[0] ? errors[0] : ''">
          <o-input type="password" v-bind="field" password-reveal></o-input>
        </o-field>
      </Field>
      <Field name="newpassword" v-slot="{ field, errors, meta }">
        <o-field
          label="新しいパスワード"
          :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
          :message="errors[0] ? errors[0] : ''">
          <o-input type="password" v-bind="field" password-reveal></o-input>
        </o-field>
      </Field>
      <Field name="confirm_newpassword" v-slot="{ field, errors, meta }">
        <o-field
          label="新しいパスワード(確認用)"
          :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
          :message="errors[0] ? errors[0] : ''">
          <o-input type="password" v-bind="field" password-reveal></o-input>
        </o-field>
      </Field>
    </section>
    <footer class="modal-card-foot">
      <o-button variant="success" native-type="submit">変更</o-button>
      <o-button @click="onCancel()">キャンセル</o-button>
    </footer>
    </Form>
  </div>
</template>
<script setup lang="ts">
import { defineProps, defineEmits } from 'vue'
import { Form, Field } from "vee-validate";
import * as yup from "yup";
import { useRouter } from 'vue-router'
import { useUserStore } from '../../store/user';
import { useProgrammatic } from '@oruga-ui/oruga-next'
import { AxiosError } from 'axios';

const userStore = useUserStore()
const { oruga } = useProgrammatic()
const router = useRouter()

const emit = defineEmits<{(e: 'close', v:{'action':String, 'method':String}):void}>()

const schema = yup.object().shape({
  oldpassword: yup.string().required().min(6),
  newpassword: yup.string().required().min(6),
  confirm_newpassword:yup.string().label("Confirmation Password").required().min(6).oneOf([yup.ref('newpassword'), null], 'Passwords must match')
});

const onSubmit = async (values:any) => {
  try {
    await userStore.updatePassword(values.oldpassword, values.newpassword)
    emit('close', {'action':'signin', 'method':''})
  } catch (e) {
    if (e instanceof AxiosError){
      oruga.notification.open({
        message: e.response?.data.description,
        rootClass: 'toast-notification',
        position: 'top',
        variant: "danger"
      })
    }
  }
}

const onCancel = async () => {
  emit('close', {'action':'cancel', 'method':'cancel'})
}

</script>
<style scoped>
@import "@creativebulma/bulma-divider";
</style>