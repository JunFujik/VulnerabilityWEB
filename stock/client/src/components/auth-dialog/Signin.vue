<template>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">サインイン</p>
    </header>
    <Form @submit="onSubmit" :validation-schema="schema">
    <section class="modal-card-body">
      <o-button tag="a" href="/api/v1/sso/google/" icon-left="google" expanded>Googleでサインイン</o-button>
      <div class="divider">or</div>
      <Field name="email" v-slot="{ field, errors, meta}">
        <o-field 
          label="メールアドレス"
          :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
          :message="errors[0] ? errors[0] : ''">
          <o-input type="email" v-bind="field" />
        </o-field>
      </Field>
      <Field name="password" v-slot="{ field, errors, meta }">
        <o-field
          label="パスワード"
          :variant="errors[0] ? 'danger' : meta.valid ? 'success' : ''"
          :message="errors[0] ? errors[0] : ''">
          <o-input type="password" v-bind="field" password-reveal></o-input>
        </o-field>
      </Field>
      <router-link @click="$emit('close', {'action':'cancel', 'method':'signup'})" to="/Signup">アカウントをお持ちではありませんか?</router-link>
    </section>
    <footer class="modal-card-foot">
      <o-button variant="success" native-type="submit">サインイン</o-button>
      <o-button @click="onCancel()">キャンセル</o-button>
    </footer>
    </Form>
  </div>
</template>
<script setup lang="ts">
import { defineProps, defineEmits } from 'vue'
import { Form, Field } from "vee-validate";
import * as yup from "yup";
import { useRouter } from 'vue-router'
import { useUserStore } from '../../store/user';
import { useProgrammatic } from '@oruga-ui/oruga-next'
import { AxiosError } from 'axios';

const userStore = useUserStore()
const { oruga } = useProgrammatic()
const router = useRouter()

const emit = defineEmits<{(e: 'close', v:{'action':String, 'method':String}):void}>()

const schema = yup.object().shape({
  email: yup.string().required().email(),
  password: yup.string().required().min(6),
});

const onSubmit = async (values:any) => {
  try {
    await userStore.signIn(values.email, values.password)
    emit('close', {'action':'signin', 'method':''})
    router.push("/")
  } catch (e) {
    if (e instanceof AxiosError){
      oruga.notification.open({
        message: e.response?.data.description,
        rootClass: 'toast-notification',
        position: 'top',
        variant: "danger"
      })
    }
  }
}

const onCancel = async () => {
  if(router.currentRoute.value.name=="Signin"){
    router.push("/")
  } else {
    emit('close', {'action':'cancel', 'method':'cancel'})
  }
}

</script>
<style scoped>
@import "@creativebulma/bulma-divider";
</style>