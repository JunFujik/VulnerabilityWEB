<template>
  <div class="columns">
    <div class="column is-one-quarter" v-for="item in props.items" :key="item.id">
      <div class="card" @click="onClick(item)">
        <div class="card-image">
          <figure class="image is-96x96">
            <img v-if="props.itemImages[item.id]" :src="props.itemImages[item.id]"
              @error="props.itemImages[item.id] = ''">
            <o-icon v-else icon="image" size="large" style="width:100%; height:100%"></o-icon>
          </figure>
        </div>
        <div class="card-content">
          <div class="media">
            <div class="media-left">
              <figure class="image is-48x48">
                <img v-if="shopImageAvailablity[item.shop_id] ?? true" :src="`/api/v1/image/shop/${item.shop_id}/`"
                  @error="shopImageAvailablity[item.shop_id]=false">
                <o-icon v-else icon="image" size="large" style="width:100%; height:100%"></o-icon>
              </figure>
            </div>
            <div class="media-content">
              <p class="title">{{ item.name }}</p>
              <p class="subtitle">{{ getShopName(item.shop_id) }}</p>
            </div>
          </div>
          <div class="content">
            {{ item.description }}
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { useShopStore } from '../store/shop';
import { openApi } from '../utils/openApi';
import ItemDialog from '../components/dialog/ItemDialog.vue';
import { useProgrammatic } from '@oruga-ui/oruga-next'
import { Item } from '../openapi';
import { ref } from 'vue';

const props = withDefaults(defineProps<{
    items:Item[],
    itemImages:{[key:string]:string},
    editable?:boolean
}>(), {
  editable:false
})

const shopImageAvailablity=ref<{[key:string]:boolean}>({})

const { oruga } = useProgrammatic()

const onClick=async (item:Item) => {
  oruga.modal.open({
    component: ItemDialog,
    props: {
      item:item,
      editable:props.editable
    },
    trapFocus: true,
  })
}

const shopStore=useShopStore()
const getShopName = (shop_id:string) => {
  for(const shop of shopStore.shops){
    if(shop.id===shop_id){
      return shop.name
    }
  }
  return openApi.getShopShopShopIdGet(shop_id).then((shop)=> shop.data.name)
}
</script>