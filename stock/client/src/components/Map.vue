<template>
  <ol-map style="width:100%; height:100%" :loadTilesWhileAnimating="true" :loadTilesWhileInteracting="true">
    <ol-view ref="view" :center="center" :zoom="zoom" :projection="projection" />
    
    <ol-attribution-control />
    <ol-zoom-control />
    <ol-zoomslider-control />

    <ol-tile-layer>
      <ol-source-osm />
    </ol-tile-layer>
    
    <ol-vector-layer>
      <ol-source-vector :url="props.url" :format="geoJson"  :projection="projection"></ol-source-vector>
      <ol-interaction-select @select="featureSelected" :condition="selectCondition">
        <ol-style>
          <ol-style-icon :src="shopIcon" :scale="1.0"></ol-style-icon>
        </ol-style>
      </ol-interaction-select>
    </ol-vector-layer>
    
    <ol-geolocation :projection="projection" @positionChanged="geoLocChange">
      <template v-slot="slotProps">
        <ol-vector-layer :zIndex="2">
          <ol-source-vector>
            <ol-feature ref="positionFeature">
              <ol-geom-point :coordinates="slotProps.position"></ol-geom-point>
              <ol-style>
                <ol-style-icon :src="hereIcon" :scale="1.0"></ol-style-icon>
              </ol-style>
            </ol-feature>
          </ol-source-vector>
        </ol-vector-layer>
      </template>
    </ol-geolocation> 
  </ol-map>
</template>
<script setup lang="ts">
import { inject, ref, defineProps, withDefaults } from 'vue';
import hereIcon from '../assets/current_loc.png'
import shopIcon from '../assets/shop.png'

const props=withDefaults(defineProps<{
  url?: string
}>(), {
  url:""
})

const emit = defineEmits<{
  (e: "select", v:any): void
}>()

const center=ref([137,37])
const zoom=ref(5)
const projection=ref("EPSG:4326")
const view=ref<any>(null)
const format = inject<any>('ol-format');
const geoJson=new format.GeoJSON()
const selectConditions = inject<any>('ol-selectconditions')
const selectCondition = selectConditions.singleClick;

const geoLocChange = async (loc:number[]) => {
  view.value.fit([loc[0], loc[1], loc[0], loc[1]], {maxZoom: 15})
}

const featureSelected = (event:any) => {
  try{
    emit("select", event.selected[0].values_)
  } catch(e) {

  }  
}
</script>
<style>
</style>